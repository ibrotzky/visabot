<!DOCTYPE html>
<html lang="en">

<head>
    <title>VisaBot CRS Calculator</title>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../css.css" />
</head>

<body>
    <div id="chat" class="chat">
        <div id="chatHistory" class="chatHistory"></div>
        <div id="question" class="question"></div>
        <div id="options" class="options"></div>
    </div>

    <script>
        var chat = $("#chat");
        var chatHistory = $("#chatHistory");
        var question = $("#question");
        var options = $("#options");

        var payload = {};

        if (window.location.href.indexOf('?') > 0) {
            payload = { "question": 44, "name": "Bruno", "married": true, "spouseCanadianCitizen": false, "spouseCommingAlong": true, "age": 27, "educationLevel": 4, "canadianDegreeDiplomaCertificate": false, "firstLanguageTest": 2, "firstLanguageSpeaking": 9, "firstLanguageListening": 9, "firstLanguageReading": 9, "firstLanguageWriting": 9, "secondLanguageTest": "0", "workExperienceInCanada": "0", "workExperienceLastTenYears": 3, "certificateQualificationProvince": false, "validJobOffer": false, "nocJobOffer": undefined, "nominationCertificate": true, "spouseAge": 42, "spouseEducationLevel": 4, "spouseCanadianDegreeDiplomaCertificate": false, "spouseFirstLanguageTest": 2, "spouseFirstLanguageSpeaking": 9, "spouseFirstLanguageListening": 9, "spouseFirstLanguageReading": 9, "spouseFirstLanguageWriting": 9, "spouseSecondLanguageTest": "0", "spouseWorkExperienceInCanada": "0", "spouseWorkExperienceLastTenYears": 3, "spouseCertificateQualificationProvince": false, "spouseValidJobOffer": false, "spouseNominationCertificate": false };

            //payload = { "question": 44, "name": "Ilya", "married": true, "spouseCanadianCitizen": true, "age": 20, "educationLevel": 3, "canadianDegreeDiplomaCertificate": true, "canadianEducationLevel": 2, "firstLanguageTest": 3, "firstLanguageSpeaking": 10, "firstLanguageListening": 10, "firstLanguageReading": 10, "firstLanguageWriting": 10, "secondLanguageTest": 2, "secondLanguageSpeaking": 10, "secondLanguageListening": 10, "secondLanguageReading": 10, "secondLanguageWriting": 10, "workExperienceInCanada": 5, "workExperienceLastTenYears": 3, "certificateQualificationProvince": true, "validJobOffer": true, "nocJobOffer": "0", "nominationCertificate": true };
        }

        function answerQuestion(answer) {
            chat.find("input").attr('disabled', 'disabled');
            chat.find("button").attr('disabled', 'disabled');

            var request = {
                "payload": payload,
                "reply": answer
            }

            console.log('Request:', request);

            $.ajax({
                type: 'GET',
                url: '/api/canada/expressEntry',
                cache: false,
                dataType: 'json',
                data: request
            }).success(function (data, textStatus, jqXHR) {
                $("<div class='question'>" + question.html() + "</div>").appendTo(chatHistory);

                if (answer !== null) {
                    $("<div class='answer'>" + answer + "</div>").appendTo(chatHistory);

                    $("<br />").appendTo(chatHistory);
                }

                var responseJSON = data.responseJSON;

                payload = responseJSON.customPayload;

                question.html(responseJSON.response);
                options.html('<br />');

                if (responseJSON.quickReplies === null) {
                    var textbox = $("<input id='reply'></input>");
                    var button = $("<button id='reply'>Reply</button>");

                    textbox.appendTo(options);
                    $("<span>&nbsp</span>").appendTo(options);
                    button.appendTo(options);

                    button.click(function () {
                        if (textbox.val().trim().length > 0)
                            answerQuestion(textbox.val());
                    });
                }
                else {
                    for (r = 0; r < responseJSON.quickReplies.length; r++) {
                        var button = $("<button id='reply" + r + "'>" + responseJSON.quickReplies[r] + "</button>");

                        button.appendTo(options);
                        $("<span>&nbsp</span>").appendTo(options);

                        button.click(function () {
                            answerQuestion($(this).text());
                        });
                    }
                }

                $("html, body").animate({ scrollTop: $(document).height() }, "slow");

                console.log('question:', payload.question);
                console.log('responseJSON:', responseJSON);
                console.log('payload:', JSON.stringify(payload));
            }).error(function (jqXHR, textStatus, errorThrown) {
                chat.find("input").removeAttr('disabled');
                chat.find("button").removeAttr('disabled');

                console.log('Error: ', jqXHR.responseText);
            });
        }

        $(window).load(function () {
            answerQuestion(null);
        });




        /*parseBoolean = function (str) {
            if (str === undefined || str === null) {
                return false;
            }
            else {
                if (typeof str !== 'string') {
                    str = str.toString();
                }

                if (isNaN(str)) {
                    switch (str.toLowerCase()) {
                        case "true":
                            return true;
                        case "false":
                            return false;
                        default:
                            throw new Error("Boolean.parse: Cannot convert string '" + str + "' to boolean.");
                    }
                }
                else {
                    if (str === '0') {
                        return false;
                    }
                    else {
                        return true;
                    }
                }
            }
        }

        var parametersUser = {};
        var calculationUser;

        parametersUser.married = parseBoolean(payload.married);
        if (payload.canadianEducationLevel !== undefined) parametersUser.spouseCanadianCitizen = parseBoolean(payload.spouseCanadianCitizen);
        if (payload.canadianEducationLevel !== undefined) parametersUser.spouseCommingAlong = parseBoolean(payload.spouseCommingAlong);
        parametersUser.age = parseInt(payload.age);
        parametersUser.educationLevel = parseInt(payload.educationLevel);
        if (payload.canadianEducationLevel !== undefined) parametersUser.educationInCanada = parseInt(payload.canadianEducationLevel);
        parametersUser.firstLanguage = languageObject();
        parametersUser.firstLanguage.test = parseInt(payload.firstLanguageTest);
        parametersUser.firstLanguage.speaking = parseInt(payload.firstLanguageSpeaking);
        parametersUser.firstLanguage.listening = parseInt(payload.firstLanguageListening);
        parametersUser.firstLanguage.reading = parseInt(payload.firstLanguageReading);
        parametersUser.firstLanguage.writing = parseInt(payload.firstLanguageWriting);
        if (parametersUser.secondLanguageTest != 0) {
            parametersUser.secondLanguage = languageObject();
            parametersUser.secondLanguage.test = (parametersUser.firstLanguage.test === languageTest.tef ? parseInt(payload.firstLanguageTest) : languageTest.tef);
            parametersUser.secondLanguage.speaking = parseInt(payload.secondLanguageSpeaking);
            parametersUser.secondLanguage.listening = parseInt(payload.secondLanguageListening);
            parametersUser.secondLanguage.reading = parseInt(payload.secondLanguageReading);
            parametersUser.secondLanguage.writing = parseInt(payload.secondLanguageWriting);
        }
        parametersUser.workInCanada = parseInt(payload.workExperienceInCanada);
        parametersUser.workExperience = parseInt(payload.workExperienceLastTenYears);
        parametersUser.certificateFromProvince = parseBoolean(payload.certificateQualificationProvince);
        parametersUser.certificateFromProvince = parseBoolean(payload.certificateQualificationProvince);
        if (payload.nocJobOffer !== undefined) parametersUser.nocJobOffer = parseInt(payload.nocJobOffer);
        parametersUser.nomination = parseBoolean(payload.nominationCertificate);

        calculationUser = calculate(parametersUser);*/
    </script>
</body>

</html>